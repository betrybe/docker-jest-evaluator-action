#!/bin/sh -l
set -x

# docker_dir=$(pwd)/docker
# work_dir=/$EVAL_CONTAINER_NAME

# docker rm -fv $EVAL_CONTAINER_NAME &> /dev/null

# docker run \
#   --name $EVAL_CONTAINER_NAME \
#   --privileged \
#   -d \
#   -w $work_dir \
#   -v $docker_dir:$work_dir \
#   mjgargani/docker:dind-trybe1.0 \

# docker exec $EVAL_CONTAINER_NAME ls -la

# docker exec $EVAL_CONTAINER_NAME ls -la ..

npm install

npm test -- --json --outputFile=evaluation.json

node ./.github/actions/docker-jest-evaluator/evaluator.js evaluation.json .trybe/requirements.json result.json

# docker rm -fv $EVAL_CONTAINER_NAME &> /dev/null

if [ $? != 0 ]; then
  echo "Execution error"
  exit 1
fi

echo ::set-output name=result::`cat result.json | base64 -w 0`

# echo "::set-output name=result::ewogICJudW1GYWlsZWRUZXN0U3VpdGVzIjoxLAogICJudW1GYWlsZWRUZXN0cyI6MSwKICAibnVtUGFzc2VkVGVzdFN1aXRlcyI6MiwKICAibnVtUGFzc2VkVGVzdHMiOjYsCiAgIm51bVBlbmRpbmdUZXN0U3VpdGVzIjowLAogICJudW1QZW5kaW5nVGVzdHMiOjAsCiAgIm51bVJ1bnRpbWVFcnJvclRlc3RTdWl0ZXMiOjAsCiAgIm51bVRvZG9UZXN0cyI6MCwKICAibnVtVG90YWxUZXN0U3VpdGVzIjozLAogICJudW1Ub3RhbFRlc3RzIjo3LAogICJvcGVuSGFuZGxlcyI6WwoKICBdLAogICJzbmFwc2hvdCI6ewogICAgICJhZGRlZCI6MCwKICAgICAiZGlkVXBkYXRlIjpmYWxzZSwKICAgICAiZmFpbHVyZSI6ZmFsc2UsCiAgICAgImZpbGVzQWRkZWQiOjAsCiAgICAgImZpbGVzUmVtb3ZlZCI6MCwKICAgICAiZmlsZXNSZW1vdmVkTGlzdCI6WwoKICAgICBdLAogICAgICJmaWxlc1VubWF0Y2hlZCI6MCwKICAgICAiZmlsZXNVcGRhdGVkIjowLAogICAgICJtYXRjaGVkIjowLAogICAgICJ0b3RhbCI6MCwKICAgICAidW5jaGVja2VkIjowLAogICAgICJ1bmNoZWNrZWRLZXlzQnlGaWxlIjpbCgogICAgIF0sCiAgICAgInVubWF0Y2hlZCI6MCwKICAgICAidXBkYXRlZCI6MAogIH0sCiAgInN0YXJ0VGltZSI6MTU4ODg3NDg4OTQwMSwKICAic3VjY2VzcyI6ZmFsc2UsCiAgInRlc3RSZXN1bHRzIjpbCiAgICAgewogICAgICAgICJhc3NlcnRpb25SZXN1bHRzIjpbCiAgICAgICAgICAgewogICAgICAgICAgICAgICJhbmNlc3RvclRpdGxlcyI6WwogICAgICAgICAgICAgICAgICJNdWx0aXBseSBtb2R1bGUiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAiZmFpbHVyZU1lc3NhZ2VzIjpbCiAgICAgICAgICAgICAgICAgIkVycm9yOiBcdTAwMWJbMm1leHBlY3QoXHUwMDFiWzIybVx1MDAxYlszMW1yZWNlaXZlZFx1MDAxYlszOW1cdTAwMWJbMm0pLlx1MDAxYlsyMm10b0JlXHUwMDFiWzJtKFx1MDAxYlsyMm1cdTAwMWJbMzJtZXhwZWN0ZWRcdTAwMWJbMzltXHUwMDFiWzJtKSAvLyBPYmplY3QuaXMgZXF1YWxpdHlcdTAwMWJbMjJtXG5cbkV4cGVjdGVkOiBcdTAwMWJbMzJtMFx1MDAxYlszOW1cblJlY2VpdmVkOiBcdTAwMWJbMzFtMVx1MDAxYlszOW1cbiAgICBhdCBPYmplY3QuPGFub255bW91cz4gKC9Vc2Vycy9qZWFuL2JldHJ5YmUvc2QtMHgtYmxvY2tZLXByb2plY3QtbmFtZS9zcmMvbXVsdGlwbHkuc3BlYy5qczo1OjI4KVxuICAgIGF0IE9iamVjdC5hc3luY0plc3RUZXN0ICgvVXNlcnMvamVhbi9iZXRyeWJlL3NkLTB4LWJsb2NrWS1wcm9qZWN0LW5hbWUvbm9kZV9tb2R1bGVzL2plc3QtamFzbWluZTIvYnVpbGQvamFzbWluZUFzeW5jSW5zdGFsbC5qczoxMDA6MzcpXG4gICAgYXQgL1VzZXJzL2plYW4vYmV0cnliZS9zZC0weC1ibG9ja1ktcHJvamVjdC1uYW1lL25vZGVfbW9kdWxlcy9qZXN0LWphc21pbmUyL2J1aWxkL3F1ZXVlUnVubmVyLmpzOjQ3OjEyXG4gICAgYXQgbmV3IFByb21pc2UgKDxhbm9ueW1vdXM+KVxuICAgIGF0IG1hcHBlciAoL1VzZXJzL2plYW4vYmV0cnliZS9zZC0weC1ibG9ja1ktcHJvamVjdC1uYW1lL25vZGVfbW9kdWxlcy9qZXN0LWphc21pbmUyL2J1aWxkL3F1ZXVlUnVubmVyLmpzOjMwOjE5KVxuICAgIGF0IC9Vc2Vycy9qZWFuL2JldHJ5YmUvc2QtMHgtYmxvY2tZLXByb2plY3QtbmFtZS9ub2RlX21vZHVsZXMvamVzdC1qYXNtaW5lMi9idWlsZC9xdWV1ZVJ1bm5lci5qczo3Nzo0MSIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJmdWxsTmFtZSI6Ik11bHRpcGx5IG1vZHVsZSBzaG91bGQgbXVsdGlwbHkgMCB3aXRoIDEiLAogICAgICAgICAgICAgICJsb2NhdGlvbiI6bnVsbCwKICAgICAgICAgICAgICAic3RhdHVzIjoiZmFpbGVkIiwKICAgICAgICAgICAgICAidGl0bGUiOiJzaG91bGQgbXVsdGlwbHkgMCB3aXRoIDEiCiAgICAgICAgICAgfSwKICAgICAgICAgICB7CiAgICAgICAgICAgICAgImFuY2VzdG9yVGl0bGVzIjpbCiAgICAgICAgICAgICAgICAgIk11bHRpcGx5IG1vZHVsZSIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJmYWlsdXJlTWVzc2FnZXMiOlsKCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAiZnVsbE5hbWUiOiJNdWx0aXBseSBtb2R1bGUgc2hvdWxkIG11bHRpcGx5IDIgd2l0aCAyIiwKICAgICAgICAgICAgICAibG9jYXRpb24iOm51bGwsCiAgICAgICAgICAgICAgInN0YXR1cyI6InBhc3NlZCIsCiAgICAgICAgICAgICAgInRpdGxlIjoic2hvdWxkIG11bHRpcGx5IDIgd2l0aCAyIgogICAgICAgICAgIH0KICAgICAgICBdLAogICAgICAgICJlbmRUaW1lIjoxNTg4ODc0ODkxMzc1LAogICAgICAgICJtZXNzYWdlIjoiXHUwMDFiWzFtXHUwMDFiWzMxbSAgXHUwMDFiWzFt4pePIFx1MDAxYlsyMm1cdTAwMWJbMW1NdWx0aXBseSBtb2R1bGUg4oC6IHNob3VsZCBtdWx0aXBseSAwIHdpdGggMVx1MDAxYlszOW1cdTAwMWJbMjJtXG5cbiAgICBcdTAwMWJbMm1leHBlY3QoXHUwMDFiWzIybVx1MDAxYlszMW1yZWNlaXZlZFx1MDAxYlszOW1cdTAwMWJbMm0pLlx1MDAxYlsyMm10b0JlXHUwMDFiWzJtKFx1MDAxYlsyMm1cdTAwMWJbMzJtZXhwZWN0ZWRcdTAwMWJbMzltXHUwMDFiWzJtKSAvLyBPYmplY3QuaXMgZXF1YWxpdHlcdTAwMWJbMjJtXG5cbiAgICBFeHBlY3RlZDogXHUwMDFiWzMybTBcdTAwMWJbMzltXG4gICAgUmVjZWl2ZWQ6IFx1MDAxYlszMW0xXHUwMDFiWzM5bVxuXHUwMDFiWzJtXHUwMDFiWzIybVxuXHUwMDFiWzJtICAgIFx1MDAxYlswbSBcdTAwMWJbOTBtIDMgfCBcdTAwMWJbMzltZGVzY3JpYmUoXHUwMDFiWzMybSdNdWx0aXBseSBtb2R1bGUnXHUwMDFiWzM5bVx1MDAxYlszM20sXHUwMDFiWzM5bSAoKSBcdTAwMWJbMzNtPT5cdTAwMWJbMzltIHtcdTAwMWJbMG1cdTAwMWJbMjJtXG5cdTAwMWJbMm0gICAgXHUwMDFiWzBtIFx1MDAxYls5MG0gNCB8IFx1MDAxYlszOW0gIGl0KFx1MDAxYlszMm0nc2hvdWxkIG11bHRpcGx5IDAgd2l0aCAxJ1x1MDAxYlszOW1cdTAwMWJbMzNtLFx1MDAxYlszOW0gKCkgXHUwMDFiWzMzbT0+XHUwMDFiWzM5bSB7XHUwMDFiWzBtXHUwMDFiWzIybVxuXHUwMDFiWzJtICAgIFx1MDAxYlswbVx1MDAxYlszMW1cdTAwMWJbMW0+XHUwMDFiWzIybVx1MDAxYlsybVx1MDAxYlszOW1cdTAwMWJbOTBtIDUgfCBcdTAwMWJbMzltICAgIGV4cGVjdChtdWx0aXBseShcdTAwMWJbMzVtMFx1MDAxYlszOW1cdTAwMWJbMzNtLFx1MDAxYlszOW0gXHUwMDFiWzM1bTFcdTAwMWJbMzltKSlcdTAwMWJbMzNtLlx1MDAxYlszOW10b0JlKFx1MDAxYlszNW0wXHUwMDFiWzM5bSlcdTAwMWJbMzNtO1x1MDAxYlszOW1cdTAwMWJbMG1cdTAwMWJbMjJtXG5cdTAwMWJbMm0gICAgXHUwMDFiWzBtIFx1MDAxYls5MG0gICB8IFx1MDAxYlszOW0gICAgICAgICAgICAgICAgICAgICAgICAgICBcdTAwMWJbMzFtXHUwMDFiWzFtXlx1MDAxYlsyMm1cdTAwMWJbMm1cdTAwMWJbMzltXHUwMDFiWzBtXHUwMDFiWzIybVxuXHUwMDFiWzJtICAgIFx1MDAxYlswbSBcdTAwMWJbOTBtIDYgfCBcdTAwMWJbMzltICB9KVx1MDAxYlszM207XHUwMDFiWzM5bVx1MDAxYlswbVx1MDAxYlsyMm1cblx1MDAxYlsybSAgICBcdTAwMWJbMG0gXHUwMDFiWzkwbSA3IHwgXHUwMDFiWzM5bVx1MDAxYlswbVx1MDAxYlsyMm1cblx1MDAxYlsybSAgICBcdTAwMWJbMG0gXHUwMDFiWzkwbSA4IHwgXHUwMDFiWzM5bSAgaXQoXHUwMDFiWzMybSdzaG91bGQgbXVsdGlwbHkgMiB3aXRoIDInXHUwMDFiWzM5bVx1MDAxYlszM20sXHUwMDFiWzM5bSAoKSBcdTAwMWJbMzNtPT5cdTAwMWJbMzltIHtcdTAwMWJbMG1cdTAwMWJbMjJtXG5cdTAwMWJbMm1cdTAwMWJbMjJtXG5cdTAwMWJbMm0gICAgICBcdTAwMWJbMm1hdCBPYmplY3QuPGFub255bW91cz4gKFx1MDAxYlsyMm1cdTAwMWJbMm1cdTAwMWJbMG1cdTAwMWJbMzZtc3JjL211bHRpcGx5LnNwZWMuanNcdTAwMWJbMzltXHUwMDFiWzBtXHUwMDFiWzJtOjU6MjgpXHUwMDFiWzIybVx1MDAxYlsybVx1MDAxYlsyMm1cbiIsCiAgICAgICAgIm5hbWUiOiIvVXNlcnMvamVhbi9iZXRyeWJlL3NkLTB4LWJsb2NrWS1wcm9qZWN0LW5hbWUvc3JjL211bHRpcGx5LnNwZWMuanMiLAogICAgICAgICJzdGFydFRpbWUiOjE1ODg4NzQ4OTA3NzIsCiAgICAgICAgInN0YXR1cyI6ImZhaWxlZCIsCiAgICAgICAgInN1bW1hcnkiOiIiCiAgICAgfSwKICAgICB7CiAgICAgICAgImFzc2VydGlvblJlc3VsdHMiOlsKICAgICAgICAgICB7CiAgICAgICAgICAgICAgImFuY2VzdG9yVGl0bGVzIjpbCiAgICAgICAgICAgICAgICAgIlN1bSBtb2R1bGUiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAiZmFpbHVyZU1lc3NhZ2VzIjpbCgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgImZ1bGxOYW1lIjoiU3VtIG1vZHVsZSBzaG91bGQgc3VtIDMgYW5kIDQiLAogICAgICAgICAgICAgICJsb2NhdGlvbiI6bnVsbCwKICAgICAgICAgICAgICAic3RhdHVzIjoicGFzc2VkIiwKICAgICAgICAgICAgICAidGl0bGUiOiJzaG91bGQgc3VtIDMgYW5kIDQiCiAgICAgICAgICAgfSwKICAgICAgICAgICB7CiAgICAgICAgICAgICAgImFuY2VzdG9yVGl0bGVzIjpbCiAgICAgICAgICAgICAgICAgIlN1bSBtb2R1bGUiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAiZmFpbHVyZU1lc3NhZ2VzIjpbCgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgImZ1bGxOYW1lIjoiU3VtIG1vZHVsZSBzaG91bGQgc3VtIDAgYW5kIDAiLAogICAgICAgICAgICAgICJsb2NhdGlvbiI6bnVsbCwKICAgICAgICAgICAgICAic3RhdHVzIjoicGFzc2VkIiwKICAgICAgICAgICAgICAidGl0bGUiOiJzaG91bGQgc3VtIDAgYW5kIDAiCiAgICAgICAgICAgfSwKICAgICAgICAgICB7CiAgICAgICAgICAgICAgImFuY2VzdG9yVGl0bGVzIjpbCiAgICAgICAgICAgICAgICAgIlN1bSBtb2R1bGUiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAiZmFpbHVyZU1lc3NhZ2VzIjpbCgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgImZ1bGxOYW1lIjoiU3VtIG1vZHVsZSBzaG91bGQgc3VtIDEgYW5kIDUiLAogICAgICAgICAgICAgICJsb2NhdGlvbiI6bnVsbCwKICAgICAgICAgICAgICAic3RhdHVzIjoicGFzc2VkIiwKICAgICAgICAgICAgICAidGl0bGUiOiJzaG91bGQgc3VtIDEgYW5kIDUiCiAgICAgICAgICAgfQogICAgICAgIF0sCiAgICAgICAgImVuZFRpbWUiOjE1ODg4NzQ4OTE2MzYsCiAgICAgICAgIm1lc3NhZ2UiOiIiLAogICAgICAgICJuYW1lIjoiL1VzZXJzL2plYW4vYmV0cnliZS9zZC0weC1ibG9ja1ktcHJvamVjdC1uYW1lL3NyYy9zdW0uc3BlYy5qcyIsCiAgICAgICAgInN0YXJ0VGltZSI6MTU4ODg3NDg5MTQ1NiwKICAgICAgICAic3RhdHVzIjoicGFzc2VkIiwKICAgICAgICAic3VtbWFyeSI6IiIKICAgICB9LAogICAgIHsKICAgICAgICAiYXNzZXJ0aW9uUmVzdWx0cyI6WwogICAgICAgICAgIHsKICAgICAgICAgICAgICAiYW5jZXN0b3JUaXRsZXMiOlsKICAgICAgICAgICAgICAgICAiUG93ZXIgbW9kdWxlIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgImZhaWx1cmVNZXNzYWdlcyI6WwoKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJmdWxsTmFtZSI6IlBvd2VyIG1vZHVsZSBzaG91bGQgcG93ZXIgMiB3aXRoIDMiLAogICAgICAgICAgICAgICJsb2NhdGlvbiI6bnVsbCwKICAgICAgICAgICAgICAic3RhdHVzIjoicGFzc2VkIiwKICAgICAgICAgICAgICAidGl0bGUiOiJzaG91bGQgcG93ZXIgMiB3aXRoIDMiCiAgICAgICAgICAgfSwKICAgICAgICAgICB7CiAgICAgICAgICAgICAgImFuY2VzdG9yVGl0bGVzIjpbCiAgICAgICAgICAgICAgICAgIlBvd2VyIG1vZHVsZSIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJmYWlsdXJlTWVzc2FnZXMiOlsKCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAiZnVsbE5hbWUiOiJQb3dlciBtb2R1bGUgc2hvdWxkIHBvd2VyIDIgd2l0aCAxIiwKICAgICAgICAgICAgICAibG9jYXRpb24iOm51bGwsCiAgICAgICAgICAgICAgInN0YXR1cyI6InBhc3NlZCIsCiAgICAgICAgICAgICAgInRpdGxlIjoic2hvdWxkIHBvd2VyIDIgd2l0aCAxIgogICAgICAgICAgIH0KICAgICAgICBdLAogICAgICAgICJlbmRUaW1lIjoxNTg4ODc0ODkxODQ0LAogICAgICAgICJtZXNzYWdlIjoiIiwKICAgICAgICAibmFtZSI6Ii9Vc2Vycy9qZWFuL2JldHJ5YmUvc2QtMHgtYmxvY2tZLXByb2plY3QtbmFtZS9zcmMvcG93ZXIuc3BlYy5qcyIsCiAgICAgICAgInN0YXJ0VGltZSI6MTU4ODg3NDg5MTY1NywKICAgICAgICAic3RhdHVzIjoicGFzc2VkIiwKICAgICAgICAic3VtbWFyeSI6IiIKICAgICB9CiAgXSwKICAid2FzSW50ZXJydXB0ZWQiOmZhbHNlCn0K"
